#
# WARP
# CI Pipeline
# Build Box Image
#

name: CI Pipeline
on:
  push:
    paths:
      - .github/workflows/box.yaml
      - "box/**"
      - makefile
      - requirements.txt
      - requirements.yaml
  create: {}
env:
  PYTHON_VERSION: "3.11"
  PACKER_VERSION: 1.8.5
  # make ansible output human readable logs
  ANSIBLE_STDOUT_CALLBACK: debug
jobs:
  build-box-vagrant:
    # macos runner is used as it supports nested virtualization,
    #
    # needed by virtualbox vm to run within github actions runner.
    # it also comes with vagrant & virtualbox preinstalled
    # https://github.com/jonashackt/vagrant-github-actions
    runs-on: macos-12
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Add Python bin directory to PATH
      run: echo "PATH=${HOME}/Library/Python/${{ env.PYTHON_VERSION }}/bin:${PATH}" >> $GITHUB_ENV

    - name: Install Python Tooling
      run: pip3 install --user -r requirements.txt

    - name: Install Packer
      uses: hashicorp-contrib/setup-packer@v2
      with:
        packer-version: ${{ env.PACKER_VERSION }}

    - name: Build WARP Box (with GUI) with Packer + Vagrant
      env:
        PACKER_GITHUB_API_TOKEN: ${{ github.token }}
        PKR_VAR_ansible_playbook: "box/ansible/gui.yaml"
      uses: nick-fields/retry@v2
      with:
        timeout_minutes: 60
        max_attempts: 3
        retry_wait_seconds: 30
        command: make box

  build-box-gcp:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        # required to fetch git branch info
        fetch-depth: "0"

    - name: Install Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Python Tooling
      run: sudo pip3 install -r requirements.txt

    - name: Install Packer
      uses: hashicorp-contrib/setup-packer@v2
      with:
        packer-version: ${{ env.PACKER_VERSION }}

    - name: Configure image name based on branch name
      run: |
        case '${{ github.ref_name }}' in
          main)
            SUFFIX=""
          ;;
          *)
            SUFFIX="-$(printf '${{ github.ref_name }}' | tr '[:punct:]' '-')"
          ;;
        esac
        echo "PKR_VAR_image_suffix=${SUFFIX}" >> $GITHUB_ENV

    - name: Build WARP Box with Packer on GCP
      env:
        GOOGLE_APPLICATION_CREDENTIALS: "/tmp/gcp_packer_key.json"
        KEY_BASE64: ${{ secrets.gcp_packer_key_base64 }}
        PKR_VAR_web_term_password: ${{ secrets.BOX_WEB_TERM_PASSWORD }}
        PACKER_GITHUB_API_TOKEN: ${{ github.token }}
      uses: nick-fields/retry@v2
      with:
        timeout_minutes: 60
        max_attempts: 2
        retry_wait_seconds: 30
        command: |
          # decode base64 & write key to disk
          echo "$KEY_BASE64" | base64 -d >$GOOGLE_APPLICATION_CREDENTIALS
          make box-gcp
