#
# WARP
# CI Pipeline
# Build Box Image
#

name: CI Pipeline
on:
  push:
    paths:
      - "box/**"
      - makefile
      - requirements.txt
env:
  PACKER_VERSION: 1.8.0
  # make ansible output human readable logs
  ANSIBLE_STDOUT_CALLBACK: debug
jobs:
  build-box-vagrant:
    # macos runner is used as it supports nested virtualization,
    # needed by virtualbox vm to run within github actions runner.
    # it also comes with vagrant & virtualbox preinstalled
    # https://github.com/jonashackt/vagrant-github-actions
    runs-on: macos-12
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install Python Tooling
      run: sudo pip3 install -r requirements.txt

    - name: Install Packer
      uses: hashicorp-contrib/setup-packer@v1
      with:
        packer-version: ${{ env.PACKER_VERSION }}

    - name: Build WARP Box with Packer + Vagrant
      env:
        PACKER_GITHUB_API_TOKEN: ${{ github.token }}
      run: make box

  build-box-gcp:
    runs-on: ubuntu-20.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        # required to fetch git branch info
        fetch-depth: "0"

    - name: Install Python Tooling
      run: sudo pip3 install -r requirements.txt

    - name: Install Packer
      uses: hashicorp-contrib/setup-packer@v1
      with:
        packer-version: ${{ env.PACKER_VERSION }}

    - name: Configure image as Development build
      if: ${{ github.ref != 'refs/heads/main' }}
      run: echo "PKR_VAR_image_suffix=-dev" >> $GITHUB_ENV

    - name: Build WARP Box with Packer on GCP
      env:
        GOOGLE_APPLICATION_CREDENTIALS: "/tmp/gcp_packer_key.json"
        KEY_BASE64: ${{ secrets.gcp_packer_key_base64 }}
        PKR_VAR_web_term_password: ${{ secrets.BOX_WEB_TERM_PASSWORD }}
      run: |
        # decode base64 & write key to disk
        echo "$KEY_BASE64" | base64 -d >$GOOGLE_APPLICATION_CREDENTIALS
        make box-gcp
